kind: Dashboard
metadata:
    name: istio-mesh
    createdAt: 0001-01-01T00:00:00Z
    updatedAt: 0001-01-01T00:00:00Z
    version: 0
    project: perses-dev
spec:
    display:
        name: Istio / Mesh
    variables:
        - kind: ListVariable
          spec:
            display:
                name: cluster
                hidden: false
            allowAllValue: false
            allowMultiple: true
            plugin:
                kind: PrometheusLabelValuesVariable
                spec:
                    datasource:
                        kind: PrometheusDatasource
                        name: prometheus-datasource
                    labelName: cluster
                    matchers:
                        - istio_requests_total{}
            name: cluster
    panels:
        "0_0":
            kind: Panel
            spec:
                display:
                    name: Global Request Volume
                    description: Total request volume across the mesh
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: requests/sec
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: round(sum(rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])), 0.01)
        "0_1":
            kind: Panel
            spec:
                display:
                    name: Global Success Rate
                    description: Overall success rate across the mesh
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(rate(istio_requests_total{reporter=~"source|waypoint",response_code!~"5.."}[$__rate_interval]))
                                    /
                                      sum(rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval]))
        "0_2":
            kind: Panel
            spec:
                display:
                    name: Global 4xx Rate
                    description: 4xx error rate across the mesh
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: requests/sec
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      round(
                                        sum(rate(istio_requests_total{reporter=~"source|waypoint",response_code=~"4.."}[$__rate_interval])),
                                        0.01
                                      )
                                    or
                                      vector(0)
        "0_3":
            kind: Panel
            spec:
                display:
                    name: Global 5xx Rate
                    description: 5xx error rate across the mesh
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: requests/sec
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      round(
                                        sum(rate(istio_requests_total{reporter=~"source|waypoint",response_code=~"5.."}[$__rate_interval])),
                                        0.01
                                      )
                                    or
                                      vector(0)
        "1_0":
            kind: Panel
            spec:
                display:
                    name: HTTP/gRPC Workloads
                    description: Request information for HTTP services
                plugin:
                    kind: Table
                    spec:
                        columnSettings:
                            - name: 'Value #requests'
                              header: Requests
                            - name: 'Value #p50'
                              header: P50 Latency
                            - name: 'Value #p90'
                              header: P90 Latency
                            - name: 'Value #p99'
                              header: P99 Latency
                            - name: 'Value #success'
                              header: Success Rate
                            - name: destination_workload_var
                              header: Workload
                            - name: destination_service
                              header: Service
                            - name: destination_workload_namespace
                            - name: destination_workload
                            - name: timestamp
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                      sum by (destination_workload, destination_workload_namespace, destination_service) (
                                        rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])
                                      ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    histogram_quantile(
                                      0.5,
                                      sum by (destination_workload, destination_workload_namespace, le) (
                                        rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval])
                                      )
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    histogram_quantile(
                                      0.9,
                                      sum by (destination_workload, destination_workload_namespace, le) (
                                        rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval])
                                      )
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    histogram_quantile(
                                      0.99,
                                      sum by (destination_workload, destination_workload_namespace, le) (
                                        rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval])
                                      )
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                        sum by (destination_workload, destination_workload_namespace) (
                                          rate(istio_requests_total{reporter=~"source|waypoint",response_code!~"5.."}[$__rate_interval])
                                        )
                                      /
                                        sum by (destination_workload, destination_workload_namespace) (
                                          rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])
                                        ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
        "2_0":
            kind: Panel
            spec:
                display:
                    name: TCP Services
                    description: TCP traffic information for services
                plugin:
                    kind: Table
                    spec:
                        columnSettings:
                            - name: 'Value #sent'
                              header: Bytes Sent
                            - name: 'Value #received'
                              header: Bytes Received
                            - name: destination_service_name
                              header: Service
                            - name: destination_service_namespace
                              header: Namespace
                            - name: timestamp
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    sum by (destination_service_name, destination_service_namespace) (
                                      rate(istio_tcp_sent_bytes_total{reporter=~"source|waypoint"}[$__rate_interval])
                                    )
                                seriesNameFormat: '{{ destination_service_name}}.{{ destination_service_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    sum by (destination_service_name, destination_service_namespace) (
                                      rate(istio_tcp_received_bytes_total{reporter=~"source|waypoint"}[$__rate_interval])
                                    )
                                seriesNameFormat: '{{ destination_service_name}}.{{ destination_service_namespace }}'
    layouts:
        - kind: Grid
          spec:
            display:
                title: Mesh Overview
            items:
                - x: 0
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_0'
                - x: 6
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_1'
                - x: 12
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_2'
                - x: 18
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_3'
        - kind: Grid
          spec:
            display:
                title: HTTP/gRPC Workloads
            items:
                - x: 0
                  "y": 0
                  width: 24
                  height: 12
                  content:
                    $ref: '#/spec/panels/1_0'
        - kind: Grid
          spec:
            display:
                title: TCP Services
            items:
                - x: 0
                  "y": 0
                  width: 24
                  height: 8
                  content:
                    $ref: '#/spec/panels/2_0'
    duration: 1h
