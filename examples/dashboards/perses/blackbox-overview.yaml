kind: Dashboard
metadata:
    name: blackbox-overview
    createdAt: 0001-01-01T00:00:00Z
    updatedAt: 0001-01-01T00:00:00Z
    version: 0
    project: perses-dev
spec:
    display:
        name: Blackbox Exporter / Overview
    variables:
        - kind: ListVariable
          spec:
            display:
                name: job
                hidden: false
            allowAllValue: false
            allowMultiple: false
            plugin:
                kind: PrometheusLabelValuesVariable
                spec:
                    datasource:
                        kind: PrometheusDatasource
                        name: prometheus-datasource
                    labelName: job
                    matchers:
                        - probe_success{}
            name: job
        - kind: ListVariable
          spec:
            display:
                name: instance
                hidden: false
            allowAllValue: false
            allowMultiple: false
            plugin:
                kind: PrometheusLabelValuesVariable
                spec:
                    datasource:
                        kind: PrometheusDatasource
                        name: prometheus-datasource
                    labelName: instance
                    matchers:
                        - probe_success{job="$job"}
            name: instance
    panels:
        "0_0":
            kind: Panel
            spec:
                display:
                    name: Status Map
                    description: Shows Probe success, either 1 if up, or 0 if down
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: decimal
                        thresholds:
                            mode: absolute
                            defaultColor: green
                            steps:
                                - value: 0
                                  color: red
                                - value: 1
                                  color: green
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: max by (instance) (probe_success{job=~"$job"})
                                seriesNameFormat: '{{instance}}'
        "1_0":
            kind: Panel
            spec:
                display:
                    name: Probes
                    description: Counts Probes Success
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: decimal
                        thresholds:
                            mode: absolute
                            defaultColor: green
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: count(probe_success{job=~"$job"})
        "1_1":
            kind: Panel
            spec:
                display:
                    name: Probes Success
                    description: Percentage of Probes Success
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        thresholds:
                            mode: absolute
                            defaultColor: red
                            steps:
                                - value: 0.99
                                  color: yellow
                                - value: 0.999
                                  color: green
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: (count(probe_success{job=~"$job"} == 1) or vector(0)) / count(probe_success{job=~"$job"})
        "1_2":
            kind: Panel
            spec:
                display:
                    name: Probes SSL
                    description: Proportion of HTTP probes that successfully used SSL
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        thresholds:
                            mode: absolute
                            defaultColor: red
                            steps:
                                - value: 0.99
                                  color: yellow
                                - value: 0.999
                                  color: green
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: count(probe_http_ssl{job=~"$job"} == 1) / count(probe_http_version{job=~"$job"})
        "1_3":
            kind: Panel
            spec:
                display:
                    name: Probe Average Duration
                    description: Duration in Seconds
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: seconds
                        thresholds:
                            mode: absolute
                            defaultColor: green
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: avg(probe_duration_seconds{job=~"$job"})
        "2_0":
            kind: Panel
            spec:
                display:
                    name: Uptime
                    description: Max uptime by instance
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        thresholds:
                            mode: absolute
                            defaultColor: red
                            steps:
                                - value: 0.99
                                  color: yellow
                                - value: 0.999
                                  color: green
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: max by (instance) (probe_success{instance=~"$instance",job=~"$job"})
                                seriesNameFormat: '{{instance}}'
        "2_1":
            kind: Panel
            spec:
                display:
                    name: Uptime 30d
                    description: 30 days uptime
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        thresholds:
                            mode: absolute
                            defaultColor: red
                            steps:
                                - value: 0.99
                                  color: yellow
                                - value: 0.999
                                  color: green
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: avg_over_time(probe_success{instance=~"$instance",job=~"$job"}[30d])
                                seriesNameFormat: '{{instance}}'
        "3_0":
            kind: Panel
            spec:
                display:
                    name: Probe Duration
                    description: Shows Probe duration in seconds
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                            mode: table
                            values:
                                - last
                        yAxis:
                            format:
                                unit: seconds
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    sum by (instance) (
                                      avg by (phase, instance) (probe_http_duration_seconds{instance=~"$instance",job=~"$job"})
                                    )
                                seriesNameFormat: HTTP duration
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: avg by (instance) (probe_duration_seconds{instance=~"$instance",job=~"$job"})
                                seriesNameFormat: Total probe duration
        "3_1":
            kind: Panel
            spec:
                display:
                    name: Probe Phases
                    description: Shows Probe duration in seconds
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                            mode: table
                            values:
                                - last
                        yAxis:
                            format:
                                unit: seconds
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: avg by (phase) (probe_http_duration_seconds{instance=~"$instance",job=~"$job"})
                                seriesNameFormat: '{{phase}}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: avg by (phase) (probe_icmp_duration_seconds{instance=~"$instance",job=~"$job"})
                                seriesNameFormat: '{{phase}}'
    layouts:
        - kind: Grid
          spec:
            display:
                title: Summary
            items:
                - x: 0
                  "y": 0
                  width: 24
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_0'
        - kind: Grid
          spec:
            display:
                title: Probes Stats
            items:
                - x: 0
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/1_0'
                - x: 6
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/1_1'
                - x: 12
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/1_2'
                - x: 18
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/1_3'
        - kind: Grid
          spec:
            display:
                title: Probes Uptimes Stats
            items:
                - x: 0
                  "y": 0
                  width: 12
                  height: 6
                  content:
                    $ref: '#/spec/panels/2_0'
                - x: 12
                  "y": 0
                  width: 12
                  height: 6
                  content:
                    $ref: '#/spec/panels/2_1'
        - kind: Grid
          spec:
            display:
                title: Probes
            items:
                - x: 0
                  "y": 0
                  width: 12
                  height: 6
                  content:
                    $ref: '#/spec/panels/3_0'
                - x: 12
                  "y": 0
                  width: 12
                  height: 6
                  content:
                    $ref: '#/spec/panels/3_1'
    duration: 1h
