apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  creationTimestamp: null
  labels:
    app.kubernetes.io/component: dashboard
    app.kubernetes.io/instance: istio-control-plane
    app.kubernetes.io/name: perses-dashboard
    app.kubernetes.io/part-of: perses-operator
  name: istio-control-plane
  namespace: perses-dev
spec:
  display:
    name: Istio Control Plane Dashboard
  duration: 1h
  layouts:
  - kind: Grid
    spec:
      display:
        title: Deployed Versions
      items:
      - content:
          $ref: '#/spec/panels/0_0'
        height: 5
        width: 24
        x: 0
        "y": 0
  - kind: Grid
    spec:
      display:
        title: Resource Usage
      items:
      - content:
          $ref: '#/spec/panels/1_0'
        height: 10
        width: 6
        x: 0
        "y": 0
      - content:
          $ref: '#/spec/panels/1_1'
        height: 10
        width: 6
        x: 6
        "y": 0
      - content:
          $ref: '#/spec/panels/1_2'
        height: 10
        width: 6
        x: 12
        "y": 0
      - content:
          $ref: '#/spec/panels/1_3'
        height: 10
        width: 6
        x: 18
        "y": 0
  - kind: Grid
    spec:
      display:
        title: Push Information
      items:
      - content:
          $ref: '#/spec/panels/2_0'
        height: 10
        width: 8
        x: 0
        "y": 0
      - content:
          $ref: '#/spec/panels/2_1'
        height: 10
        width: 8
        x: 8
        "y": 0
      - content:
          $ref: '#/spec/panels/2_2'
        height: 10
        width: 8
        x: 16
        "y": 0
      - content:
          $ref: '#/spec/panels/2_3'
        height: 10
        width: 8
        x: 0
        "y": 10
      - content:
          $ref: '#/spec/panels/2_4'
        height: 10
        width: 8
        x: 8
        "y": 10
      - content:
          $ref: '#/spec/panels/2_5'
        height: 10
        width: 8
        x: 16
        "y": 10
  - kind: Grid
    spec:
      display:
        title: Webhooks
      items:
      - content:
          $ref: '#/spec/panels/3_0'
        height: 8
        width: 12
        x: 0
        "y": 0
      - content:
          $ref: '#/spec/panels/3_1'
        height: 8
        width: 12
        x: 12
        "y": 0
  panels:
    "0_0":
      kind: Panel
      spec:
        display:
          description: Version number of each running instance.
          name: Pilot Versions
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (tag) (istio_build{component="pilot"})
                seriesNameFormat: Version ({{tag}})
    "1_0":
      kind: Panel
      spec:
        display:
          description: Memory usage of each running instance
          name: Memory Usage
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
              - last
              - max
            visual:
              areaOpacity: 0.1
              display: line
              lineWidth: 1
              palette:
                mode: ""
            yAxis:
              format:
                unit: bytes
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (pod) (container_memory_working_set_bytes{container="discovery",pod=~"istiod-.*"})
                seriesNameFormat: Container ({{pod}})
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (pod) (go_memstats_stack_inuse_bytes{app="istiod"})
                seriesNameFormat: Stack ({{pod}})
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (pod) (go_memstats_heap_inuse_bytes{app="istiod"})
                seriesNameFormat: Heap (In Use) ({{pod}})
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (pod) (go_memstats_heap_alloc_bytes{app="istiod"})
                seriesNameFormat: Heap (Allocated) ({{pod}})
    "1_1":
      kind: Panel
      spec:
        display:
          description: Details about memory allocations
          name: Memory Allocations
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
              - last
              - max
            visual:
              areaOpacity: 0.1
              display: line
              lineWidth: 1
              palette:
                mode: ""
            yAxis:
              format:
                unit: bytes/sec
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (pod) (rate(go_memstats_alloc_bytes_total{app="istiod"}[$__rate_interval]))
                seriesNameFormat: Bytes ({{pod}})
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (pod) (rate(go_memstats_mallocs_total{app="istiod"}[$__rate_interval]))
                seriesNameFormat: Objects ({{pod}})
    "1_2":
      kind: Panel
      spec:
        display:
          description: CPU usage of each running instance
          name: CPU Usage
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
              - last
              - max
            visual:
              areaOpacity: 0.1
              display: line
              lineWidth: 1
              palette:
                mode: ""
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: |-
                  sum by (pod) (
                    irate(container_cpu_usage_seconds_total{container="discovery",pod=~"istiod-.*"}[$__rate_interval])
                  )
                seriesNameFormat: Container ({{pod}})
    "1_3":
      kind: Panel
      spec:
        display:
          description: Goroutine count for each running instance
          name: Goroutines
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
              - last
              - max
            visual:
              areaOpacity: 0.1
              display: line
              lineWidth: 1
              palette:
                mode: ""
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (pod) (go_goroutines{app="istiod"})
                seriesNameFormat: Goroutines ({{pod}})
    "2_0":
      kind: Panel
      spec:
        display:
          description: Rate of XDS pushes by type.
          name: XDS Pushes
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (type) (irate(pilot_xds_pushes[$__rate_interval]))
                seriesNameFormat: '{{type}}'
    "2_1":
      kind: Panel
      spec:
        display:
          description: Events from Kubernetes API server.
          name: Events
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (type, event) (rate(pilot_k8s_reg_events[$__rate_interval]))
                seriesNameFormat: '{{type}} {{event}}'
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (type, event) (rate(pilot_k8s_cfg_events[$__rate_interval]))
                seriesNameFormat: '{{type}} {{event}}'
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (type) (rate(pilot_push_triggers[$__rate_interval]))
                seriesNameFormat: '{{type}}'
    "2_2":
      kind: Panel
      spec:
        display:
          description: Total number of XDS connections.
          name: Connections
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(envoy_cluster_upstream_cx_active{cluster_name="xds-grpc"})
                seriesNameFormat: Connections (client reported)
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(pilot_xds)
                seriesNameFormat: Connections ( reported)
    "2_3":
      kind: Panel
      spec:
        display:
          description: Errors pushing to Envoy.
          name: Push Errors
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (type) (pilot_total_xds_rejects)
                seriesNameFormat: 'Rejected: {{type}}'
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: pilot_total_xds_internal_errors
                seriesNameFormat: Internal Error
    "2_4":
      kind: Panel
      spec:
        display:
          description: |-
            Count of active and pending proxies managed by each instance.
            Pending is expected to converge to zero.
          name: Push Time
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: milliseconds
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (le) (rate(pilot_xds_push_time_bucket[1m]))
                seriesNameFormat: '{{le}}'
    "2_5":
      kind: Panel
      spec:
        display:
          description: Size of each xDS push.
          name: Push Size
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: bytes
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum by (le) (rate(pilot_xds_config_size_bytes_bucket[1m]))
                seriesNameFormat: '{{le}}'
    "3_0":
      kind: Panel
      spec:
        display:
          description: Webhook validation success/failure rate.
          name: Validation
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(galley_validation_passed[1m]))
                seriesNameFormat: Success
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(galley_validation_failed[1m]))
                seriesNameFormat: Failure
    "3_1":
      kind: Panel
      spec:
        display:
          description: Webhook injection success/failure rate.
          name: Injection
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(sidecar_injection_success_total[1m]))
                seriesNameFormat: Success
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(sidecar_injection_failure_total[1m]))
                seriesNameFormat: Failure
status: {}
