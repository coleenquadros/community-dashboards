apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  creationTimestamp: null
  labels:
    app.kubernetes.io/component: dashboard
    app.kubernetes.io/instance: istio-performance
    app.kubernetes.io/name: perses-dashboard
    app.kubernetes.io/part-of: perses-operator
  name: istio-performance
  namespace: perses-dev
spec:
  display:
    name: Istio / Performance
  duration: 1h
  layouts:
  - kind: Grid
    spec:
      display:
        title: Data Plane Performance
      items:
      - content:
          $ref: '#/spec/panels/0_0'
        height: 8
        width: 12
        x: 0
        "y": 0
      - content:
          $ref: '#/spec/panels/0_1'
        height: 8
        width: 12
        x: 12
        "y": 0
  - kind: Grid
    spec:
      display:
        title: Control Plane Performance
      items:
      - content:
          $ref: '#/spec/panels/1_0'
        height: 8
        width: 12
        x: 0
        "y": 0
      - content:
          $ref: '#/spec/panels/1_1'
        height: 8
        width: 12
        x: 12
        "y": 0
  - kind: Grid
    spec:
      display:
        title: Operations Performance
      items:
      - content:
          $ref: '#/spec/panels/2_0'
        height: 8
        width: 12
        x: 0
        "y": 0
      - content:
          $ref: '#/spec/panels/2_1'
        height: 8
        width: 12
        x: 12
        "y": 0
  panels:
    "0_0":
      kind: Panel
      spec:
        display:
          description: Memory usage of Envoy proxies in the data plane
          name: Data Plane Memory
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: bytes
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: envoy_server_memory_allocated_bytes
                seriesNameFormat: '{{instance}}'
    "0_1":
      kind: Panel
      spec:
        display:
          description: CPU usage of Envoy proxies in the data plane
          name: Data Plane CPU
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: percent
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: rate(envoy_server_stats_recent_lookups[1m]) * 100
                seriesNameFormat: '{{instance}}'
    "1_0":
      kind: Panel
      spec:
        display:
          description: Time taken to push configuration to Envoy proxies
          name: Proxy Push Time
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: milliseconds
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: histogram_quantile(0.5, sum by (le) (rate(pilot_proxy_convergence_time_bucket[1m])))
                seriesNameFormat: P50
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: histogram_quantile(0.9, sum by (le) (rate(pilot_proxy_convergence_time_bucket[1m])))
                seriesNameFormat: P90
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: histogram_quantile(0.99, sum by (le) (rate(pilot_proxy_convergence_time_bucket[1m])))
                seriesNameFormat: P99
    "1_1":
      kind: Panel
      spec:
        display:
          description: Size of proxy push queue
          name: Proxy Queue Size
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: pilot_proxy_queue_time
                seriesNameFormat: '{{instance}}'
    "2_0":
      kind: Panel
      spec:
        display:
          description: Rate of configuration validation operations
          name: Configuration Validation
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(galley_validation_passed[1m]))
                seriesNameFormat: Passed
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(galley_validation_failed[1m]))
                seriesNameFormat: Failed
    "2_1":
      kind: Panel
      spec:
        display:
          description: Rate of sidecar injection operations
          name: Sidecar Injection
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            visual:
              areaOpacity: 0.5
              display: line
              lineWidth: 0.25
              palette:
                mode: auto
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(sidecar_injection_success_total[1m]))
                seriesNameFormat: Success
        - kind: TimeSeriesQuery
          spec:
            plugin:
              kind: PrometheusTimeSeriesQuery
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: prometheus-datasource
                query: sum(rate(sidecar_injection_failure_total[1m]))
                seriesNameFormat: Failure
  variables:
  - kind: ListVariable
    spec:
      allowAllValue: false
      allowMultiple: true
      display:
        hidden: false
        name: cluster
      name: cluster
      plugin:
        kind: PrometheusLabelValuesVariable
        spec:
          datasource:
            kind: PrometheusDatasource
            name: prometheus-datasource
          labelName: cluster
          matchers:
          - pilot_build_info{}
status: {}
