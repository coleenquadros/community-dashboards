{
  "apiVersion": "perses.dev/v1alpha1",
  "kind": "PersesDashboard",
  "metadata": {
    "labels": {
      "app.kubernetes.io/name": "perses-dashboard",
      "app.kubernetes.io/instance": "istio-workload-dashboard",
      "app.kubernetes.io/part-of": "perses-operator"
    },
    "name": "istio-workload-dashboard",
    "namespace": "istio"
  },
  "spec": {
    "display": {
      "name": "Istio Workload Dashboard"
    },
    "panels": {
      "incoming_request_volume": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Incoming Request Volume",
            "description": "Request volume by source workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "reqps"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_requests_total{reporter=~\"$qrep\", connection_security_policy=\"mutual_tls\", destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{source_workload}}.{{source_workload_namespace}} (üîêmTLS)"
                  }
                }
              }
            },
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_requests_total{reporter=~\"$qrep\", connection_security_policy!=\"mutual_tls\", destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{source_workload}}.{{source_workload_namespace}}"
                  }
                }
              }
            }
          ]
        }
      },
      "incoming_success_rate": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Incoming Success Rate",
            "description": "Success rate by source workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "min"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "percent-decimal"
                },
                "min": 0,
                "max": 1
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "sum(irate(istio_requests_total{reporter=~\"$qrep\", destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\", response_code!~\"5.*\"}[$__rate_interval])) by (source_workload, source_workload_namespace) / sum(irate(istio_requests_total{reporter=~\"$qrep\", destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace)",
                    "seriesNameFormat": "{{source_workload}}.{{source_workload_namespace}}"
                  }
                }
              }
            }
          ]
        }
      },
      "incoming_request_duration": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Incoming Request Duration",
            "description": "Request duration percentiles by source workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "ms"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "histogram_quantile(0.50, sum(irate(istio_request_duration_milliseconds_bucket{reporter=~\"$qrep\", destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace, le))",
                    "seriesNameFormat": "{{source_workload}}.{{source_workload_namespace}} P50"
                  }
                }
              }
            },
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "histogram_quantile(0.99, sum(irate(istio_request_duration_milliseconds_bucket{reporter=~\"$qrep\", destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace, le))",
                    "seriesNameFormat": "{{source_workload}}.{{source_workload_namespace}} P99"
                  }
                }
              }
            }
          ]
        }
      },
      "outgoing_request_volume": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Outgoing Request Volume",
            "description": "Request volume to destination services"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "reqps"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_requests_total{reporter=\"source\", source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\", destination_service=~\"$dstsvc\", destination_workload=~\"$dstwl\", destination_workload_namespace=~\"$dstns\"}[$__rate_interval])) by (destination_service, destination_workload, destination_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{destination_service}} ({{destination_workload}}.{{destination_workload_namespace}})"
                  }
                }
              }
            }
          ]
        }
      },
      "outgoing_success_rate": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Outgoing Success Rate",
            "description": "Success rate to destination services"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "min"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "percent-decimal"
                },
                "min": 0,
                "max": 1
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "sum(irate(istio_requests_total{reporter=\"source\", source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\", destination_service=~\"$dstsvc\", destination_workload=~\"$dstwl\", destination_workload_namespace=~\"$dstns\", response_code!~\"5.*\"}[$__rate_interval])) by (destination_service, destination_workload, destination_workload_namespace) / sum(irate(istio_requests_total{reporter=\"source\", source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\", destination_service=~\"$dstsvc\", destination_workload=~\"$dstwl\", destination_workload_namespace=~\"$dstns\"}[$__rate_interval])) by (destination_service, destination_workload, destination_workload_namespace)",
                    "seriesNameFormat": "{{destination_service}} ({{destination_workload}}.{{destination_workload_namespace}})"
                  }
                }
              }
            }
          ]
        }
      },
      "tcp_received_bytes": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "TCP Bytes Received",
            "description": "TCP bytes received from source workloads"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes/sec"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_tcp_received_bytes_total{reporter=\"destination\", destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{source_workload}}.{{source_workload_namespace}}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "layouts": [
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Incoming Requests",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/incoming_request_volume"
              }
            },
            {
              "x": 8,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/incoming_success_rate"
              }
            },
            {
              "x": 16,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/incoming_request_duration"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Outgoing Requests",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/outgoing_request_volume"
              }
            },
            {
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/outgoing_success_rate"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "TCP Traffic",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 24,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/tcp_received_bytes"
              }
            }
          ]
        }
      }
    ],
    "variables": [
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Reporter",
            "hidden": false
          },
          "defaultValue": "destination",
          "allowAllValue": false,
          "allowMultiple": false,
          "sort": "",
          "plugin": {
            "kind": "StaticListVariable",
            "spec": {
              "values": [
                "source",
                "destination"
              ]
            }
          },
          "name": "qrep"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Namespace",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total) by (destination_workload_namespace) or sum(istio_tcp_sent_bytes_total) by (destination_workload_namespace)",
              "labelName": "destination_workload_namespace"
            }
          },
          "name": "namespace"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Workload",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{destination_workload_namespace=~\"$namespace\"}) by (destination_workload) or sum(istio_tcp_sent_bytes_total{destination_workload_namespace=~\"$namespace\"}) by (destination_workload)",
              "labelName": "destination_workload"
            }
          },
          "name": "workload"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Source Workload Namespace",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\"}) by (source_workload_namespace) or sum(istio_tcp_sent_bytes_total{destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\"}) by (source_workload_namespace)",
              "labelName": "source_workload_namespace"
            }
          },
          "name": "srcns"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Source Workload",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload_namespace=~\"$srcns\"}) by (source_workload) or sum(istio_tcp_sent_bytes_total{destination_workload=~\"$workload\", destination_workload_namespace=~\"$namespace\", source_workload_namespace=~\"$srcns\"}) by (source_workload)",
              "labelName": "source_workload"
            }
          },
          "name": "srcwl"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Destination Service",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\"}) by (destination_service) or sum(istio_tcp_sent_bytes_total{source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\"}) by (destination_service)",
              "labelName": "destination_service"
            }
          },
          "name": "dstsvc"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Destination Workload Namespace",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\", destination_service=~\"$dstsvc\"}) by (destination_workload_namespace) or sum(istio_tcp_sent_bytes_total{source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\", destination_service=~\"$dstsvc\"}) by (destination_workload_namespace)",
              "labelName": "destination_workload_namespace"
            }
          },
          "name": "dstns"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Destination Workload",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\", destination_service=~\"$dstsvc\", destination_workload_namespace=~\"$dstns\"}) by (destination_workload) or sum(istio_tcp_sent_bytes_total{source_workload=~\"$workload\", source_workload_namespace=~\"$namespace\", destination_service=~\"$dstsvc\", destination_workload_namespace=~\"$dstns\"}) by (destination_workload)",
              "labelName": "destination_workload"
            }
          },
          "name": "dstwl"
        }
      }
    ],
    "duration": "1h",
    "refreshInterval": "0s"
  }
}