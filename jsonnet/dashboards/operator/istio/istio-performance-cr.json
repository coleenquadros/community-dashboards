{
  "apiVersion": "perses.dev/v1alpha1",
  "kind": "PersesDashboard",
  "metadata": {
    "labels": {
      "app.kubernetes.io/name": "perses-dashboard",
      "app.kubernetes.io/instance": "istio-performance",
      "app.kubernetes.io/part-of": "perses-operator"
    },
    "name": "istio-performance",
    "namespace": "istio"
  },
  "spec": {
    "display": {
      "name": "Istio Performance Dashboard"
    },
    "panels": {
      "bytestransferred": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Bytes transferred / sec"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "list",
                "position": "bottom",
                "values": []
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes/sec"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "sum(irate(istio_response_bytes_sum{source_workload=\"istio-ingressgateway\", reporter=\"source\"}[$__rate_interval]))",
                    "seriesNameFormat": "istio-ingressgateway"
                  }
                }
              }
            },
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "sum(irate(istio_request_bytes_sum{source_workload=\"istio-ingressgateway\", reporter=\"source\"}[$__rate_interval]))",
                    "seriesNameFormat": "istio-ingressgateway"
                  }
                }
              }
            }
          ]
        }
      },
      "istio_component_versions": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Istio Component Versions",
            "description": "Version number of each running instance"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "list",
                "position": "bottom",
                "values": []
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "sum by (component,tag) (istio_build)",
                    "seriesNameFormat": "{{component}} ({{tag}})"
                  }
                }
              }
            }
          ]
        }
      },
      "istiod_disk": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Istiod disk",
            "description": "The disk usage of Istiod"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": [
                  "last",
                  "max"
                ]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "container_fs_usage_bytes{container=\"discovery\", pod=~\"istiod-.*\"}",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      },
      "istiod_goroutines": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Istiod goroutines",
            "description": "The number of goroutines in Istiod. A proxy that is sending a lot of requests to Istiod may cause this to be elevated."
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": [
                  "last",
                  "max"
                ]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "go_goroutines{app=\"istiod\"}",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      },
      "istiod_memory": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Istiod memory",
            "description": "The memory usage of Istiod"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": [
                  "last",
                  "max"
                ]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "container_memory_working_set_bytes{container=\"discovery\", pod=~\"istiod-.*\"}",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      },
      "istiod_vcpu": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Istiod vCPU",
            "description": "The CPU usage of Istiod"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": [
                  "last",
                  "max"
                ]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "irate(container_cpu_usage_seconds_total{container=\"discovery\", pod=~\"istiod-.*\"}[$__rate_interval])",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      },
      "performancedashboard": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Performance Dashboard"
          },
          "plugin": {
            "kind": "Markdown",
            "spec": {
              "text": "## Performance Dashboard\n\nThis dashboard shows the resource usage of the Istio control plane.\n\n### Istiod resource usage\n\nIstiod's resource usage is primarily determined by the rate of change of the configuration. During stable state, it should consume minimal resources.\n\n### Proxy resource usage\n\nProxy resource usage is primarily determined by the amount of traffic flowing through the proxy and the number of connections it is handling.\n\nFor more information, see [Istio Performance and Scalability](https://istio.io/latest/docs/ops/deployment/performance-and-scalability/)."
            }
          },
          "queries": []
        }
      },
      "proxy_disk": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Proxy disk",
            "description": "The disk usage of the proxy"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": [
                  "last",
                  "max"
                ]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "container_fs_usage_bytes{container=\"istio-proxy\"}",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      },
      "proxy_memory": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Proxy memory",
            "description": "The memory usage of the proxy"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": [
                  "last",
                  "max"
                ]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "container_memory_working_set_bytes{container=\"istio-proxy\"}",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      },
      "proxy_vcpu": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Proxy vCPU",
            "description": "The CPU usage of the proxy"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": [
                  "last",
                  "max"
                ]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "irate(container_cpu_usage_seconds_total{container=\"istio-proxy\"}[$__rate_interval])",
                    "seriesNameFormat": "{{pod}}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "layouts": [
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Performance Dashboard Notes",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 24,
              "height": 6,
              "content": {
                "$ref": "#/spec/panels/performancedashboard"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Data Plane",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/bytestransferred"
              }
            },
            {
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/istio_component_versions"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Control Plane",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/istiod_disk"
              }
            },
            {
              "x": 8,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/istiod_goroutines"
              }
            },
            {
              "x": 16,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/istiod_memory"
              }
            },
            {
              "x": 0,
              "y": 8,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/istiod_vcpu"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Data Plane",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/proxy_disk"
              }
            },
            {
              "x": 8,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/proxy_memory"
              }
            },
            {
              "x": 16,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/proxy_vcpu"
              }
            }
          ]
        }
      }
    ],
    "variables": [],
    "duration": "1h",
    "refreshInterval": "0s"
  }
}