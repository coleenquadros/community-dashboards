{
  "apiVersion": "perses.dev/v1alpha1",
  "kind": "PersesDashboard",
  "metadata": {
    "labels": {
      "app.kubernetes.io/name": "perses-dashboard",
      "app.kubernetes.io/instance": "istio-service-dashboard",
      "app.kubernetes.io/part-of": "perses-operator"
    },
    "name": "istio-service-dashboard",
    "namespace": "istio"
  },
  "spec": {
    "display": {
      "name": "Istio Service Dashboard"
    },
    "panels": {
      "client_request_volume": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Client Request Volume",
            "description": "Request volume by source workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "reqps"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_requests_total{reporter=~\"$qrep\", destination_service=~\"$service\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{ source_workload }}.{{ source_workload_namespace }}"
                  }
                }
              }
            }
          ]
        }
      },
      "client_success_rate": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Client Success Rate",
            "description": "Success rate by source workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "min"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "percent-decimal"
                },
                "min": 0,
                "max": 1
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "sum(irate(istio_requests_total{reporter=~\"$qrep\", destination_service=~\"$service\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\", response_code!~\"5.*\"}[$__rate_interval])) by (source_workload, source_workload_namespace) / sum(irate(istio_requests_total{reporter=~\"$qrep\", destination_service=~\"$service\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace)",
                    "seriesNameFormat": "{{ source_workload }}.{{ source_workload_namespace }}"
                  }
                }
              }
            }
          ]
        }
      },
      "client_request_duration": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Client Request Duration",
            "description": "Request duration percentiles by source workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "ms"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "histogram_quantile(0.50, sum(irate(istio_request_duration_milliseconds_bucket{reporter=~\"$qrep\", destination_service=~\"$service\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace, le))",
                    "seriesNameFormat": "P50 {{ source_workload }}.{{ source_workload_namespace }}"
                  }
                }
              }
            },
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "histogram_quantile(0.99, sum(irate(istio_request_duration_milliseconds_bucket{reporter=~\"$qrep\", destination_service=~\"$service\", source_workload=~\"$srcwl\", source_workload_namespace=~\"$srcns\"}[$__rate_interval])) by (source_workload, source_workload_namespace, le))",
                    "seriesNameFormat": "P99 {{ source_workload }}.{{ source_workload_namespace }}"
                  }
                }
              }
            }
          ]
        }
      },
      "server_request_volume": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Server Request Volume",
            "description": "Request volume by destination workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "reqps"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_requests_total{reporter=\"destination\", destination_service=~\"$service\", destination_workload=~\"$dstwl\", destination_workload_namespace=~\"$dstns\"}[$__rate_interval])) by (destination_workload, destination_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{ destination_workload }}.{{ destination_workload_namespace }}"
                  }
                }
              }
            }
          ]
        }
      },
      "tcp_bytes_received": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "TCP Bytes Received",
            "description": "TCP bytes received by destination workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes/sec"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_tcp_received_bytes_total{reporter=\"destination\", destination_service=~\"$service\", destination_workload=~\"$dstwl\", destination_workload_namespace=~\"$dstns\"}[$__rate_interval])) by (destination_workload, destination_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{ destination_workload }}.{{ destination_workload_namespace }}"
                  }
                }
              }
            }
          ]
        }
      },
      "tcp_bytes_sent": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "TCP Bytes Sent",
            "description": "TCP bytes sent by destination workload"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "legend": {
                "mode": "table",
                "position": "bottom",
                "values": ["last", "max"]
              },
              "visual": {
                "areaOpacity": 0.1,
                "connectNulls": false,
                "display": "line",
                "lineWidth": 1
              },
              "yAxis": {
                "format": {
                  "unit": "bytes/sec"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "datasource": {
                      "kind": "PrometheusDatasource",
                      "name": "prometheus"
                    },
                    "query": "round(sum(irate(istio_tcp_sent_bytes_total{reporter=\"destination\", destination_service=~\"$service\", destination_workload=~\"$dstwl\", destination_workload_namespace=~\"$dstns\"}[$__rate_interval])) by (destination_workload, destination_workload_namespace), 0.001)",
                    "seriesNameFormat": "{{ destination_workload }}.{{ destination_workload_namespace }}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "layouts": [
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Client Workloads",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/client_request_volume"
              }
            },
            {
              "x": 8,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/client_success_rate"
              }
            },
            {
              "x": 16,
              "y": 0,
              "width": 8,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/client_request_duration"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "Service Workloads",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 24,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/server_request_volume"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "TCP Traffic",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/tcp_bytes_received"
              }
            },
            {
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/tcp_bytes_sent"
              }
            }
          ]
        }
      }
    ],
    "variables": [
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Reporter",
            "hidden": false
          },
          "defaultValue": "destination",
          "allowAllValue": false,
          "allowMultiple": false,
          "sort": "",
          "plugin": {
            "kind": "StaticListVariable",
            "spec": {
              "values": [
                "source",
                "destination"
              ]
            }
          },
          "name": "qrep"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Service",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "alphabetical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total) by (destination_service) or sum(istio_tcp_sent_bytes_total) by (destination_service)",
              "labelName": "destination_service"
            }
          },
          "name": "service"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Client Workload Namespace",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "numerical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{reporter=~\"$qrep\", destination_service=\"$service\"}) by (source_workload_namespace) or sum(istio_tcp_sent_bytes_total{reporter=~\"$qrep\", destination_service=~\"$service\"}) by (source_workload_namespace)",
              "labelName": "source_workload_namespace"
            }
          },
          "name": "srcns"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Client Workload",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "numerical-desc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{reporter=~\"$qrep\", destination_service=~\"$service\", source_workload_namespace=~\"$srcns\"}) by (source_workload) or sum(istio_tcp_sent_bytes_total{reporter=~\"$qrep\", destination_service=~\"$service\", source_workload_namespace=~\"$srcns\"}) by (source_workload)",
              "labelName": "source_workload"
            }
          },
          "name": "srcwl"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Service Workload Namespace",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "numerical-asc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{reporter=\"destination\", destination_service=\"$service\"}) by (destination_workload_namespace) or sum(istio_tcp_sent_bytes_total{reporter=\"destination\", destination_service=~\"$service\"}) by (destination_workload_namespace)",
              "labelName": "destination_workload_namespace"
            }
          },
          "name": "dstns"
        }
      },
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Service Workload",
            "hidden": false
          },
          "defaultValue": "$__all",
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "numerical-desc",
          "plugin": {
            "kind": "PrometheusPromQLVariable",
            "spec": {
              "expr": "sum(istio_requests_total{reporter=\"destination\", destination_service=~\"$service\", destination_workload_namespace=~\"$dstns\"}) by (destination_workload) or sum(istio_tcp_sent_bytes_total{reporter=\"destination\", destination_service=~\"$service\", destination_workload_namespace=~\"$dstns\"}) by (destination_workload)",
              "labelName": "destination_workload"
            }
          },
          "name": "dstwl"
        }
      }
    ],
    "duration": "1h",
    "refreshInterval": "0s"
  }
}